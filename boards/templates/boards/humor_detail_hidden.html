{% if posting %}
<div class="container my-3">
    <h2 class="border-bottom py-2">{{ posting.subject }}</h2>

    <div class="card my-3">
        <div class="card-body">
            <div class="card-text" style="white-space: pre-line;">{{ posting.content| safe  }}</div>


            <div class="d-flex justify-content-end">
                <div class="badge badge-light p-2">
                    <div>작성자:{{ posting.author.nickname }}</div>
                    <div>작성일:{{ posting.create_date }}</div>
                    수정일:{{posting.modify_date}}
                </div>
            </div>
            <h6>출처 : <a href="{{posting.source}}">{{posting.source}}</a></h6>
        </div>




                    <!---태그 추가 부분-->
            <labe for = "tags">태그</labe>
            {% for tag in posting.tag.all %}
        <span>
            <a href="{% url 'scientific_humor:tag_info' tag.name %}">
                    #{{ tag.name }}</a>
            {% endfor %}
        </span>
    </div>

    <div>
        <button
        {% if user in posting.like_users.all %}
        class="btn btn-primary"
        {% else %}
        class="btn btn-dark"
        {% endif %}
        onclick="like_click({{posting.id}})" id="like_check">추천({{ posting.like_count }})</button>

        <button
        {% if user in posting.dislike_users.all %}
        class="btn btn-warning"
        {% else %}
        class="btn btn-dark"
        {% endif %}
        onclick="dislike_click({{posting.id}})" id="dislike_check">비추천({{ posting.dislike_count }})</button>
    </div>

<script>
let like_count = {{ posting.like_count }}  // 좋아요 숫자 지정.

function like_click(id) {
    console.log(id);
    var like_object = document.getElementById('like_check');  // 버튼 요소객체 지정.
    $.ajax({
        type:'POST',
        url: "{% url 'scientific_humor:posting_like' posting.id %}",     // data를 전송할 url.
        data:{'posting_id': id,
                'csrfmiddlewaretoken': '{{ csrf_token }}',

        },                                      // posting_id 라는 이름으로 id 값 전송
        dataType: "json",
        success: function (response){                      // ajax 통신이 정상적으로 완료되었을 때
            console.log("응답성공");
            if (response.like_check == true) {  // 추천에 성공했다면.
                console.log(response.like_check);
                like_object.className = "btn btn-primary";
                like_count += 1
                like_object.innerHTML = "추천(" + like_count + ")"
            } else {
                console.log(response.like_check);
                like_object.className = "btn btn-dark";
                like_count -= 1
                like_object.innerHTML = "추천(" + like_count + ")"
            }
        },
        error: function (response){
            console.log('실패');
        }
    });
}

let dislike_count = {{ posting.dislike_count }}  // 좋아요 숫자 지정.

function dislike_click(id) {
    console.log(id);
    var like_object = document.getElementById('dislike_check');  // 버튼 요소객체 지정.
    $.ajax({
        type:'POST',
        url: "{% url 'scientific_humor:posting_dislike' posting.id %}",     // data를 전송할 url.
        data:{'posting_id': id,
                'csrfmiddlewaretoken': '{{ csrf_token }}',

        },                                      // posting_id 라는 이름으로 id 값 전송
        dataType: "json",
        success: function (response){                      // ajax 통신이 정상적으로 완료되었을 때
            console.log("응답성공");
            if (response.like_check == true) {  // 추천에 성공했다면.
                console.log(response.like_check);
                like_object.className = "btn btn-warning";
                dislike_count += 1
                like_object.innerHTML = "비추천(" + dislike_count + ")"
            } else {
                console.log(response.like_check);
                like_object.className = "btn btn-dark";
                dislike_count -= 1
                like_object.innerHTML = "비추천(" + dislike_count + ")"
            }
        },
        error: function (response){
            console.log('실패');
        }
    });
}
            /*
            $('.toast').fadeIn(400).delay(100).fadeOut(400) //class가 toast인 것을 서서히 나타나게 하는 메서드입니다.
            }
            else {console.log("hi")};
            }
            })
            }
            */
</script>







{% if request.user == posting.author %} <!--해당 작성자 일때만 수정, 삭제 버튼이 보이게끔!-->
<a href="{% url 'scientific_humor:modify' posting.id%}" class="btn btn-primary">수정</a>
<a href="#" data-uri="{% url 'scientific_humor:delete' posting.id  %}" class="delete btn btn-primary">삭제</a>

<!-- delete를 포함하는 클래스가 있으면 작동한다. data-uri 속성은 jQuery에서 $(this).data('uri') 형태로 받아가기 위해서 작성.-->
<script type='text/javascript'>
$(document).ready(function(){
    $(".delete").on('click', function() {
        if(confirm("님, 정말로 지움??")) {
            location.href = $(this).data('uri');
        }
    });
});
</script>
<!-- 취소를 누르면 아무 일도 하지 않는다.-->
{% endif %}



<!------------------------------------------------------------댓글_1을 보기 위한 것----------------->
<h5 class="border-bottom my-3 py-2">{{posting.answer_set.count}}개의 댓글이 있습니다.</h5>

<div class="mt-3"><!-- 댓글_1을 담기 위한 공간. 너무 많아서.. 따로 처리하는 것도 좋을듯;-->
    {% for answer in posting.answer_set.all %}
    <div class="card my-3">
        <div class="card-body">
            <div class="card-text" style="white-space: pre-line;">{{ answer.content }}</div>
            <a id="answer_{{answer.id}}"></a> <!-- 댓글_1등록 후 해당 댓글_1으로 오게 하기 위한 앵커 -->
            <div class="d-flex justify-content-end">
                <div class="badge badge-light p-2">
                    <div>{{ answer.author.nickname }}</div>
                    {{ answer.create_date }}
                </div>
            </div>
        </div>
        </div>

        <!--댓글_1수정, 삭제-->
            {% if request.user == answer.author %}<!--댓글_1 작성자에게만 보이게끔.-->
            <div class="my-3">
                <a href="{% url 'scientific_humor:answer_update' answer.id  %}"
                   class="btn btn-sm btn-outline-secondary">수정</a>
                        <a href="#" class="delete btn btn-sm btn-outline-secondary "
                   data-uri="{% url 'scientific_humor:answer_delete' answer.id  %}">삭제</a>
            </div>

            {% endif %}
        <!--대댓글 기능!-->
        {% if answer.comment_set.count > 0 %}
        <div id="comment_area_{{ answer.id }}">
        {% for comment in answer.comment_set.all %}<!--댓글객체에서 대댓글 객체를 뽑아낸다.-->
        <div class="mt-3">
                <span style="white-space: pre-line;">{{ comment.content }}</span>
                <span>
                    - {{ comment.author.nickname }}, {{ comment.create_date }}
                    {% if comment.modify_date %}
                    (수정:{{ comment.modify_date }})
                    {% endif %}
                </span>
                {% if request.user == comment.author %}
                <a href="#" class="small delete"
                   data-uri="{% url 'scientific_humor:comment_delete' comment.id  %}">삭제</a>
                    {% endif %}
        </div>
        {% endfor %}
        {% endif %}
            <div>
                <!--폼에러를 나타내기 위한 것-->
    {% if form.errors %}
    <div class="alert alert-danger" role="alert">
    {% for field in form %}
        {% if field.errors %}
        <strong>{{ field.label }}</strong>
        {{ field.errors }}
        {% endif %}
    {% endfor %}
    </div>
    {% endif %}
            <span onclick="show_comment_input_area_({{answer.id}})">대댓글 추가하기</span>
                <div style="display:none" id="comment_input_area_{{answer.id}}">
                    <form action="{% url 'scientific_humor:comment_create' answer.id  %}" method="post">
                    {% csrf_token %}
                    <textarea id="comment_input_area{{answer.id}}" class="form-control" name="content" placeholder="150자까지. 대댓글은 수정 안되니 신중히~"></textarea>
                    <input type="submit" class="btn btn-primary" value="대댓글등록">
                    </form>
                </div>
            </div>
    {% endfor %}
    </div>

<script>
function show_comment_input_area_(id){
    $("#comment_input_area_"+id).show();
    console.log("댓글칸"+id)
    }

function comment_create(id,url) {
    console.log(url)
    let content = document.getElementById("comment_input_area"+id).value;
    console.log(content)
    if(content.length > 150){
        alert('댓글은 150자까지. 현재 글자수 : ' + content.length);
        return;
    }
    window.location.href="url"
}


</script>

<!--댓글_1등록을 위한 것---------------------------------------------------------------->
    댓글 추가하기
<form action="{% url 'scientific_humor:answer_create' posting.id %}" method="post">
{% csrf_token %}
<!--폼에러를 나타내기 위한 것-->
    {% if form.errors %}
    <div class="alert alert-danger" role="alert">
    {% for field in form %}
        {% if field.errors %}
        <strong>{{ field.label }}</strong>
        {{ field.errors }}
        {% endif %}
    {% endfor %}
    </div>
    {% endif %}
    <!--댓글_1등록을 위한 칸---->
    <div class="form-group">
            <textarea class="form-control" name="content" placeholder="300자까지. 넘으면 에러남."
                      id="content" rows="2">{{ form.content.value|default_if_none:'' }}</textarea>
    <input type="submit" class="btn btn-primary" value="댓글등록">
</form>
    </div>
</div>
{% endif %}