{% extends "school_report/section.html" %}

{% block content %}
여기는 제출페이지입니당
  <form action="{% url 'school_report:homework_survey_submit' submit.id%}" method="post" enctype="multipart/form-data">
      {% csrf_token %}
    <div id="questionContainer">
        {% for question in question_list %}
              <div id="question{{forloop.counter}}" class="card my-3">
                <div class="card-body">
                  <div class="form-group">
                      <input type="hidden" name="question" value="{{question.id}}">  <!--문항에 대한 것도 들어와야할듯.-->
                    {% if question.is_essential %}<span class="text-danger">(필수)</span>
                      <input type="hidden" name="is_essential" value="True">
                    {% endif %}
          <!-- 형식에 따라 다른 html 호출. -->
          {% include "school_report/classroom/homework/survey/submit_case/"|add:question.question_type|add:".html" with question=question %}
                  </div>
                </div>
              </div>
        {% endfor %}
    </div> 




    <div class="mt-3">
      <button type="submit" id="submit-button" class="btn btn-primary">제출</button>
    </div>
  </form>


<script>
document.getElementById('submit-button').addEventListener('click', function(event) {
    event.preventDefault();

    var inputs = document.querySelectorAll('input[name^="response"], textarea[name^="response"], .question');
    var isValid = true;

    for (var i = 0; i < inputs.length; i++) {
        var input = inputs[i];

        if (input.matches('.question')) {
            // 객관식 질문 검사 (기존 코드 유지)
            var parent = input.parentNode;
            var checkboxes, minSelections;

            if (input.querySelector('input[type=checkbox]')) {
                checkboxes = input.querySelectorAll('input[type=checkbox]:checked');
                minSelections = parseInt(parent.querySelector('input[name=lower_lim]').value, 10);
            } else if (input.querySelector('input[type=radio]')) {
                checkboxes = input.querySelectorAll('input[type=radio]:checked');
                minSelections = 1;
            }

            if (checkboxes.length < minSelections) {
                alert('객관식 질문에서 최소 ' + minSelections + '개를 선택해야 합니다.');
                var card = input.closest('.card');
                card.style.backgroundColor = '#f8d7da';
                card.scrollIntoView({block: 'center'});
                isValid = false;
            } else {
                var card = input.closest('.card');
                card.style.backgroundColor = '';
            }
        } else {
            // 필수 입력 필드 검사
            var parent = input.parentNode;
            var isEssential = parent.querySelector('input[name="is_essential"][value="True"]');
            if (isEssential && input.value.trim() === '') {
                alert('필수 질문에 답변해주세요.');
                var card = parent.closest('.card');
                card.style.backgroundColor = '#f8d7da';
                card.scrollIntoView({block: 'center'});
                isValid = false;
            } else {
                var card = parent.closest('.card');
                card.style.backgroundColor = '';
            }
        }
    }

    // 글자 수 검증 추가
    var textareas = document.querySelectorAll('textarea[name^="response"]');
    for (var j = 0; j < textareas.length; j++) {
        var textarea = textareas[j];
        var lowerLim = parseInt(textarea.parentNode.querySelector('div').textContent.match(/최소 (\d+)자/)[1] || 0, 10);
        var upperLim = parseInt(textarea.parentNode.querySelector('div').textContent.match(/최대 (\d+)자/)[1] || 0, 10);
        var count = textarea.value.length;

        if ((lowerLim && count < lowerLim) || (upperLim && count > upperLim)) {
            alert('응답이 글자 수 제한을 초과하거나 미달입니다.');
            var card = textarea.closest('.card');
            card.style.backgroundColor = '#f8d7da';
            card.scrollIntoView({block: 'center'});
            isValid = false;
        } else {
            var card = textarea.closest('.card');
            card.style.backgroundColor = '';
        }
    }

    if (isValid) {
        event.currentTarget.form.submit();
    }
});
</script>


{% endblock %}
