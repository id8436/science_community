{% extends "school_report/section.html" %}

{% block content %}
여기는 제출페이지입니당
  <form action="{% url 'school_report:homework_survey_submit' submit.id%}" method="post" enctype="multipart/form-data">
      {% csrf_token %}
    <div id="questionContainer">
        {% for question in question_list %}
              <div id="question{{forloop.counter}}" class="card my-3">
                <div class="card-body">
                  <div class="form-group">
                      <input type="hidden" name="question" value="{{question.id}}">  <!--문항에 대한 것도 들어와야할듯.-->
                    {% if question.is_essential %}<span class="text-danger">(필수)</span>
                      <input type="hidden" name="is_essential" value="True">
                    {% endif %}
          <!-- 형식에 따라 다른 html 호출. -->
          {% include "school_report/classroom/homework/survey/submit_case/"|add:question.question_type|add:".html" with question=question %}
                  </div>
                </div>
              </div>
        {% endfor %}
    </div> 




    <div class="mt-3">
      <button type="submit" id="submit-button" class="btn btn-primary">제출</button>
    </div>
  </form>

<script>
document.getElementById('submit-button').addEventListener('click', function(event) {
    // 배경색 초기화
    var cards = document.querySelectorAll('.card');
    cards.forEach(function(card) {
        card.style.backgroundColor = '';
    });

    var isValid = true;  // 전체 form 제출 여부에 대한 판단.

    // 각 질문에 대해 검사
    cards.forEach(function(card) {
        var isEssential = card.querySelector('input[name="is_essential"]');
        var responseField = card.querySelector('input[name^="response"], textarea[name^="response"]');

        if (isEssential) {
            // 객관식 검사
            var checkboxes = card.querySelectorAll('input[type=checkbox]:checked');
            var radios = card.querySelectorAll('input[type=radio]:checked');
            var lowerLim = parseInt(card.querySelector('input[name=lower_lim]')?.value || 0, 10);
            // 체크박스 유효성 검사
            if (checkboxes.length > 0) {  // 체크박스가 있어야 진행됨.
                if (checkboxes.length < lowerLim && lowerLim > 0) {
                    showError(card, '객관식 질문에서 최소 ' + lowerLim + '개를 선택해야 합니다.');
                    isValid = false;
                    return; // 다음 카드로 이동
                }
                // 체크박스가 통과했으므로 더 이상 검사하지 않음(이거 안해주면 이거 통과해도 다음 필터링에 걸려서;;)
                return;
            }

            // 라디오 버튼 유효성 검사
            if (radios.length > 0) {
                if (radios.length < 1) {
                    showError(card, '객관식 질문에서 하나 이상의 선택이 필요합니다.');
                    isValid = false;
                    return; // 다음 카드로 이동
                }
                // 라디오 버튼이 통과했으므로 더 이상 검사하지 않음
                return;
            }

            // 일반 응답 필드 검증
            if (!responseField || responseField.value.trim() === '') {
                showError(card, '필수 질문에 답변해주세요.');
                isValid = false;
                return; // 다음 카드로 이동
            }

            // 장문형 검증
            if (responseField.tagName === 'TEXTAREA') {
                var limits = card.querySelector('div').textContent;
                var lowerLimText = parseInt(limits.match(/최소 (\d+)자/)?.[1] || -1, 10);
                var upperLimText = parseInt(limits.match(/최대 (\d+)자/)?.[1] || -1, 10);
                var count = responseField.value.length;
                console.log(lowerLimText);
                if ((lowerLimText > -1 && count < lowerLimText) || (upperLimText > -1 && count > upperLimText)) {
                    showError(card, '응답이 글자 수 제한을 초과하거나 미달입니다.');
                    isValid = false;
                }
            }
        }
    }); // 'forEach' 루프의 닫는 중괄호

    if (isValid) {
        event.currentTarget.form.submit();
    } else {
        event.preventDefault();
    }

    function showError(card, message) {
        alert(message); // 또는 다른 방법으로 사용자에게 메시지를 표시할 수 있습니다.
        card.style.backgroundColor = '#f8d7da';
        card.scrollIntoView({ block: 'center' });
    }
}); // 'addEventListener'의 닫는 중괄호
</script>

{% endblock %}