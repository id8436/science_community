{% extends "school_report/section.html" %}

{% block content %}
<div class="container my-3">

<h2 class="border-bottom py-2">{{ posting.subject }}</h2>

<div class="card my-3">
    <div class="card-body">
        <div class="card-text" style="white-space: pre-line;">{{ posting.content| safe  }}</div>
    </div>

        <div class="d-flex justify-content-end">
            <div class="badge text-bg-light p-2">
                <div>작성자:{{ posting.author.nickname }}</div>
                <div>작성일:{{ posting.create_date }}</div>
                수정일:{{posting.modify_date}}
                <div>마감일:{{ posting.deadline }}</div>
            </div>
        </div>

</div>

<!-- 삭제, 수정 버튼. -->
<div class="position-relative">
<div class="position-absolute top-0 start-50 translate-middle">
</div>
{% if request.user == posting.author_profile.admin %} <!--해당 작성자 일때만 수정, 삭제 버튼이 보이게끔!-->
    {% if survey %}
        <div><a href="{% url 'school_report:homework_survey_create' posting.id%}" class="btn btn-primary">설문 문항 수정하기</a>
            <a href="{% url 'school_report:homework_distribution' posting.id%}" class="btn btn-info">과제 재분배</a>
            {% if posting.is_special == 'peerReview' %}
                {% if posting.is_end %}
                    <a href="{% url 'school_report:homework_end_cancel' posting.id %}">마감 취소</a>
                    <a href="{% url 'school_report:peerreview_who_is_special' posting.id %}">댓글 선발 통계</a>
                {%else%}
                    <a href="{% url 'school_report:peerreview_create' posting.id %}">동료평가 설문 지정하기</a>
                    <a href="{% url 'school_report:peerreview_end' posting.id %}">동료평가 설문 마감하기</a>
                {% endif %}
            {% elif postion.is_special %}
                특수설문.
            {% else %}
                <a href="{% url 'school_report:homework_survey_list' posting.id%}" class="btn btn-info">특수설문 제작하기</a>
            {% endif %}
        <a href="{% url 'school_report:homework_survey_statistics_spreadsheet' posting.id%}" class="btn btn-info">설문 스프레드시트형 통계</a>
        </div>

    {% else %}
        <div>
            <a href="{% url 'school_report:homework_survey_create' posting.id%}" class="btn btn-primary">설문문항 제작하기</a>
        </div>
        <div></div>
    {% endif %}
<a href="{% url 'school_report:homework_modify' posting.id%}" class="btn btn-primary">과제 수정</a>
<a href="{% url 'school_report:homework_copy' posting.id%}" class="btn btn-info">과제 복사</a>
<a href="#" data-uri="{% url 'school_report:homework_delete' posting.id  %}" class="posting_delete btn btn-danger">과제 삭제</a>
    <a href="{% url 'school_report:homework_end' posting.id%}" class="btn btn-primary">과제 마감</a>

</div>
<!-- delete를 포함하는 클래스가 있으면 작동한다. data-uri 속성은 jQuery에서 $(this).data('uri') 형태로 받아가기 위해서 작성.-->
<script type='text/javascript'>
$(document).ready(function(){
    $(".posting_delete").on('click', function() {
        if(confirm("님, 정말로 지움??")) {
            location.href = $(this).data('uri');
        }
    });
});
</script><!-- 취소를 누르면 아무 일도 하지 않는다.-->


<table class="table table-hover" id="submit_list">
    <thead>
    <tr class="table-info">
        <th>제출자</th>
        <th>상태</th>
        <th>제출시각</th>
        <th>제출내용</th>
    </tr>
    </thead>
    <tbody>
    {% if submit_list %}
    {% for annoIndividual in submit_list %}
    <tr>
        <td>{{annoIndividual.to_profile}}{{annoIndividual.to_profile.id}}</td>
        {% if annoIndividual.check %}
        <td>제출{% if annoIndividual.state%}<h6 style="color: red;">({{annoIndividual.state}}){%endif%}</h6></td>
        <td>{{annoIndividual.submit_date|date:'m.d H:i'}}</td>
        {% elif annoIndividual.read %}
        <td class="table-secondary" colspan="2">읽음</td>
        {% else %}
        <td class="table-danger" colspan="2">미열람</td>
        {% endif %}
        <td>
            {% if survey %}
            설문제출 <a href="{% url 'school_report:homework_below_standard_set' annoIndividual.id%}" class="btn btn-danger">수준미달 지정</a>
            <a href="{% url 'school_report:homework_below_standard_unset' annoIndividual.id%}" class="btn btn-info">수준미달 해제</a>
            {% else %}
            {{annoIndividual.content}}
            {% endif %}
            {% if posting.is_special == 'peerReview'%}
            {{ annoIndividual.to_student }}{% endif %}
        </td>
    </tr>
    {% endfor %}
    {% endif %}
    </tbody>
</table>

{%endif%}


{% if posting.is_special == 'peerReview' %}<!--  동료평가에 대하여.  -->
    {% if score_mean %}
    동료평가 평균 부여 점수 : {{score_mean}}점.  부여 분산 : {{variance}}
    {% endif %}
    {% if posting.is_end %}
        <a href="{% url 'school_report:peerreview_statistics' posting.id %}">최종 통계 보기</a>
    {% endif %}
{% endif %}


{% if survey %}
<table class="table table-hover" id="submit_status">
    <thead>
    <tr class="table-info">
        <th>제출자</th>
        <th>상태</th>
        <th>제출시각</th>
        <th>제출내용</th>
    </tr>
    </thead>
    <tbody>
    {% if private_submits %}
    {% for private_submit in private_submits%}
    <tr>
        <td>{{private_submit.to_profile}}</td>
        {% if private_submit.check %}
        <td>제출{% if private_submit.state%}<h6 style="color: red;">({{private_submit.state}})</h6>{%endif%}</td>
        <td>{{private_submit.submit_date|date:'m.d H:i'}}</td>
        {% elif private_submit.read %}
        <td class="table-secondary" colspan="2">읽음</td>
        {% else %}
        <td class="table-danger" colspan="2">미열람</td>
        {% endif %}
        <td>
            {% if survey %}
            <a href="{% url 'school_report:homework_survey_submit' private_submit.id%}" class="btn btn-info">
                {% if private_submit.title %}{{private_submit.title}}
                {% elif posting.is_special == 'peerReview' %}연습
                {%endif%}설문하기</a>
            {% if posting.secret %}결과는 비밀~{%else%}
            <a href="{% url 'school_report:homework_survey_statistics' private_submit.id%}" class="btn btn-info">설문 통계</a>
            {% endif %}

            {% else %}
            {{private_submit.content}}
            {% endif %}
        </td>
    </tr>
    {%endfor%}
    {% endif %}
    </tbody>
</table>
{% else %}


<!-- 요 아래 부분은 과제제출 기능 초장기의 흔적인데... 뭐, 안쓰면 알아서 지우기.-->
{% if individual_announcement %}
<div>
    {{individual_announcement.to_student}}

        {% if individual_announcement.check %}
            <h5 class="border-bottom">제출 과제 확인</h5>

            <div class="card my-3">
            <div class="card-body">
            {{individual_announcement.content}}
                <div class="badge text-bg-light p-2">
                <div>작성일:{{ individual_announcement.submit_date }}</div>
            </div>
        </div>
            </div>
    <a data-uri="{% url 'school_report:homework_resubmit' individual_announcement.id %}" class="homework_submit btn btn-primary">수정 제출하기</a>
<script type='text/javascript'>
    $(document).ready(function(){
        $(".homework_submit").on('click', function() {
        if(confirm("수정하게 되면 제출 날짜가 갱신됩니다~!")) {
            location.href = $(this).data('uri');
        }
    });
});
</script><!-- 취소를 누르면 아무 일도 하지 않는다.-->
        {% else %}
            <h2>아직 제출이 안되었습니다~</h2>
            <!-- 에러처리 -->
            {% include "form_errors.html" %}
            <h5 class="my-3 border-bottom pb-2">과제 제출</h5>
            <!-- 폼 처리-->
            <form method="post" enctype="multipart/form-data" class="post-form my-3" onsubmit="return confirm('한번 확인하면 취소 못하니, 신중히 확인하세요~!')">
                {% csrf_token %}
                <div class="form-group">
                <textarea type="text" class="form-control" name="content" id="content"
                    placeholder="내용을 입력해주세요~">{{ individual_announcement.content|default_if_none:'' }}</textarea>
                </div>
                <input type="submit" class="btn btn-primary" value='제출'>
            </form>
{%endif%}


</div>
{% endif %}

{% endif %}

</div>




{% endblock content %}