{% extends 'custom_account/section.html' %}

{% block content %}
<div class="container my-5">
    <h1 class="text-center mb-4">OAuth2.0 사용법</h1>

    <div class="card shadow-sm">
        <div class="card-body">
            <h2>1. 사용자를 로그인시키고 권한 요청 (Authorization Code 발급)</h2>
            <p>사용자는 아래 URL을 통해 로그인을 하고, 권한을 승인한 후 `code`를 얻습니다.</p>

            <div class="alert alert-info" role="alert">
                <strong>요청 URL:</strong>
                <code>http://{{내도메인}}/o/authorize/?</code>
            </div>

            <p>필요한 파라미터는 다음과 같습니다:</p>
            <ul class="list-group">
                <li class="list-group-item">response_type: <strong>"code"</strong> (인증 흐름으로 Authorization Code 방식을 사용)</li>
                <li class="list-group-item">client_id: <strong>클라이언트(어플리케이션) 등록 시 발급된 ID</strong></li>
                <li class="list-group-item">redirect_uri: <strong>등록한 URI 중 하나여야 함</strong></li>
                <li class="list-group-item">state: <strong>CSRF 방지를 위한 값 (서버에서 검증용)</strong> — 권장, 사실상 필수</li>
            </ul>

            <div class="alert alert-warning mt-3" role="alert">
                <strong>예시 요청 URL:</strong>
                <code>http://{{ request.get_host }}/o/authorize/?response_type=code&client_id=발급된ID&redirect_uri=http://본인도메인/callback&state=random123</code>
            </div>
          <div class="alert alert-success mt-3" role="alert">
    <strong>응답 예시:</strong>
    <code>
{
  "access_token": "ya29.a0AfH6SMBZ...",
  "token_type": "Bearer",
  "expires_in": 3600,
  "scope": "read write",
  "refresh_token": "1//0gXNj5W5..."
}
    </code>
</div>
        </div>
    </div>

    <div class="card shadow-sm mt-5">
        <div class="card-body">
            <h2>2. 토큰 요청 (Authorization Code로 토큰 발급)</h2>
            <p>사용자는 `code`를 받은 후, 해당 코드를 사용해 `access_token`을 얻기 위해 아래 URL로 POST 요청을 보냅니다.</p>

            <div class="alert alert-info" role="alert">
                <strong>요청 URL:</strong>
                <code>http://{{ request.get_host }}/o/token/</code>
            </div>

            <p>POST 요청의 내용은 다음과 같습니다:</p>
            <pre class="bg-light p-3">
Content-Type: application/x-www-form-urlencoded

client_id=abc123
client_secret=xyz789
grant_type=authorization_code
code=받은코드
redirect_uri=http://본인도메인/callback
            </pre>

            <div class="alert alert-success mt-3" role="alert">
                <strong>응답 예시:</strong>
                <code>
{
  "access_token": "...",
  "refresh_token": "...",
  "expires_in": 36000,
  "token_type": "Bearer",
  "scope": "read"
}
                </code>
            </div>
        </div>
    </div>

</div>

<h1 class="text-center mb-4">OAuth2.0 클라이언트(어플리케이션) 목록</h1>
{% load custom_tags %}

<div class="row row-cols-1 row-cols-md-2 g-4">
  {% for app in apps %}
    <div class="col">
      <div class="card h-100 shadow-sm">
        <div class="card-body">
          <h5 class="card-title d-flex justify-content-between align-items-center">
            {{ app.name }}
            <span>
            <a class="btn btn-outline-primary btn-sm" href="{% url 'custom_account:OAuth_client_edit' app.pk %}">정보 수정</a>
            <a class="btn btn-outline-danger btn-sm" href="{% url 'custom_account:OAuth_delete_client' app.pk %}"
            onclick="return confirm('정말로 삭제하시겠습니까? 되돌릴 수 없습니다.');">삭제</a>
            </span>
          </h5>
          <p><strong>Client ID:</strong> {{ app.client_id }}</p>
          <p><strong>Client Secret:</strong> {{ app.client_secret }}</p>
          <p><strong>Redirect URIs:</strong></p>
          <ul class="list-group list-group-flush">
            {% for uri in app.redirect_uris|split:" " %}
              <li class="list-group-item">{{ uri }}
                  <a href="http://{{ request.get_host }}/o/authorize/?response_type=code&client_id={{ app.client_id }}&redirect_uri={{uri}}&state=random123"
                       class="btn btn-outline-success"
                       role="button" target="_blank">
                       OAuth2.0 인증 코드 요청
                    </a>
              </li>

            {% empty %}
              <li class="list-group-item text-muted">(등록된 URI가 없습니다)</li>
            {% endfor %}
          </ul>

        </div>
      </div>
    </div>
  {% empty %}
    <p class="text-muted">등록된 클라이언트 애플리케이션이 없습니다.</p>
  {% endfor %}
</div>

<a href="{% url 'custom_account:OAuth_register_client' %}" class="btn btn-outline-primary">
  새 어플리케이션 등록.</a>



{% endblock %}