{# image_upload_by_ajax.html #}
{# Required context vars:
  input_id: (e.g. 'post_image')
  upload_url: URL to send image to (e.g. '/upload-image/')
  csrf_token: CSRF token string
  Optional:
    input_name: defaults to input_id
    preview_id: defaults to input_id + '_preview'
    insert_js_callback: JavaScript function to call with image URL
#}


<div class="image-upload-container">
  <input type="file"
         id="{{ input_id }}"
         name="{{ input_name|default:input_id }}"
         accept="image/*">
  <div id="{{ preview_id|default:input_id|add:'_preview' }}"></div>
</div>

<script>
  const inputEl = document.getElementById('{{ input_id }}');
  const previewEl = document.getElementById('{{ preview_id|default:input_id|add:"_preview" }}');

  inputEl.addEventListener('change', function () {
    const file = this.files[0];
    if (!file) return;

    const formData = new FormData();
    formData.append('{{ input_name|default:input_id }}', file);

    fetch('{{ upload_url }}', {
      method: 'POST',
      body: formData,
      headers: {
        'X-CSRFToken': '{{ csrf_token }}',
      },
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        const url = data.url;
        {% if insert_js_callback %}
        {{ insert_js_callback }}(url);
        {% else %}
        previewEl.innerHTML = `<img src="${url}" alt="업로드 이미지">`;
        {% endif %}
      } else {
        alert('업로드 실패: ' + data.error);
      }
    })
    .catch(err => alert('오류 발생: ' + err));
  });
</script>
